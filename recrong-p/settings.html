<!DOCTYPE html>
<html lang="en" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    <title>Recron - Settings</title>
    <style>
        :root { --primary: #0070f3; --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --bg: #f5f7fa; --card-bg: #ffffff; --text: #333; --border: #eaeaea; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }

        .container { max-width: 600px; margin: 20px auto; padding: 0 20px; }
        @media (max-width: 600px) { .container { padding: 15px; margin: 0; } }

        /* é¡¶éƒ¨å¯¼èˆª */
        .nav-header { margin-bottom: 10px; }
        .nav-back { display: inline-flex; align-items: center; gap: 6px; text-decoration: none; color: #666; font-weight: 500; font-size: 1rem; transition: color 0.2s; padding: 5px 0; }
        .nav-back:hover { color: var(--primary); }
        .nav-arrow { font-size: 1.2rem; line-height: 1; margin-bottom: 2px; }

        /* å·¥å…·æ  */
        .toolbar { background: var(--card-bg); padding: 15px 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .toolbar h1 { margin: 0; font-size: 1.25rem; font-weight: 700; color: #111; }

        /* å¡ç‰‡å®¹å™¨ */
        .card {
            background: var(--card-bg); padding: 25px; border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .card-header { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .card-header h2 { margin: 0; font-size: 1.1rem; color: #444; }

        /* è¡¨å•å…ƒç´  */
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #555; }
        input {
            width: 100%; padding: 10px 12px; border: 1px solid var(--border);
            border-radius: 8px; background: #f9fafb; font-size: 0.95rem;
            transition: all 0.2s; box-sizing: border-box;
        }
        input:focus { background: #fff; border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,112,243,0.1); }

        /* æŒ‰é’®æ ·å¼ */
        button {
            padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; font-size: 0.95rem;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        }
        button:active { transform: scale(0.97); }
        button:disabled { opacity: 0.7; cursor: not-allowed; }

        .btn-primary { background-color: var(--primary); color: white; width: 100%; box-shadow: 0 4px 12px rgba(0,118,255,0.25); }
        .btn-primary:hover:not(:disabled) { background-color: #0060df; }

        .btn-secondary { background-color: #fff; border: 1px solid var(--border); color: #444; padding: 6px 12px; font-size: 0.85rem; }
        .btn-secondary:hover { border-color: #999; color: #000; }

        .btn-danger { background-color: #fff0f0; color: var(--danger); border: 1px solid transparent; }
        .btn-danger:hover { border-color: var(--danger); background-color: #fee2e2; }

        .btn-link { background: none; color: var(--primary); padding: 0; font-weight: 500; font-size: 0.9rem; text-decoration: none; display: inline-flex; align-items: center; margin-bottom: 20px; }
        .btn-link:hover { text-decoration: underline; }

        /* ç”¨æˆ·ä¿¡æ¯å±•ç¤º */
        .user-profile {
            display: flex; align-items: center; gap: 12px; margin-bottom: 25px;
            background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border);
        }
        .avatar-placeholder {
            width: 40px; height: 40px; background: #e0e7ff; color: var(--primary);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.1rem;
            flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
        }
        .user-details {
            display: flex; flex-direction: column;
        }
        .user-details div:first-child { font-weight: 600; font-size: 0.85rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .user-details div:last-child { font-weight: 700; font-size: 1.1rem; color: #111; }

        /* ç”¨æˆ· ID æ ‡ç­¾æ ·å¼ */
        .user-id-tag {
            margin-left: auto;
            background: #fff7ed; /* æµ…æ©™è‰²èƒŒæ™¯ */
            border: 1px solid #fdba74; /* æ©™è‰²è¾¹æ¡† */
            color: #c2410c; /* æ·±æ©™è‰²æ–‡å­— */
            padding: 4px 12px;
            border-radius: 20px;
            font-family: "SF Mono", "Roboto Mono", monospace;
            font-size: 0.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(234, 88, 12, 0.1);
        }
        .hash-symbol {
            color: #fb923c; /* äº®æ©™è‰²äº•å· */
            margin-right: 2px;
            font-weight: 500;
        }

        /* Toast & Modal */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; }
        .toast { background: white; padding: 12px 20px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); font-size: 0.95rem; font-weight: 500; display: flex; align-items: center; gap: 10px; animation: slideDown 0.3s ease-out; pointer-events: all; border-left: 4px solid transparent; }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.2s; }
        .modal-overlay.show { opacity: 1; }
        .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 16px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.2s; }
        .modal-overlay.show .modal-box { transform: scale(1); }
        .modal-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 10px; }
        .modal-msg { color: #555; margin-bottom: 20px; line-height: 1.5; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        /* å¼¹çª—æŒ‰é’®ç­‰å®½ */
        .modal-actions button { min-width: 80px; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 600px) {
            .hide-mobile { display: none; }
            .toolbar h1 { font-size: 1.1rem; }
            .card { padding: 20px; }
        }

        /* åº•éƒ¨é¡µè„šæ ·å¼ */
        .footer-info {
            text-align: center;
            margin-top: 40px;
            padding-bottom: 30px;
            color: #999;
            animation: fadeIn 0.5s ease-in-out;
        }
        .contact-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .footer-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #666;
            text-decoration: none;
            font-size: 0.85rem;
            padding: 6px 12px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 20px;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .footer-link:hover {
            color: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        .copyright {
            font-size: 0.8rem;
            color: #666;
            margin-top: 15px;
        }
        /* é’ˆå¯¹åè®®é“¾æ¥çš„æ ·å¼ */
        .copyright a {
            color: #666;       /* é“¾æ¥é¢œè‰²ä¸æ–‡å­—ä¸€è‡´ */
            text-decoration: none;
            transition: color 0.2s;
            font-weight: 500;
        }

        .copyright a:hover {
            color: var(--primary); /* æ‚¬åœæ—¶å˜é»‘/ä¸»è‰² */
            text-decoration: none;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
    <script src="/config.js?v=1.0.1"></script>
    <script src="/i18n.js?v=1.0.1"></script>
</head>
<body>

    <div id="toast-container"></div>
    <div class="container">
        <!-- é¡¶éƒ¨è¿”å›åŒºåŸŸ (ç‹¬ç«‹ä¸€è¡Œ) -->
        <div class="nav-header">
            <a href="/dashboard.html" class="nav-back">
                <span class="nav-arrow">â†</span>
                <span data-i18n="back_dashboard">è¿”å›ä¸»é¢æ¿</span>
            </a>
        </div>

        <!-- å·¥å…·æ  (æ ‡é¢˜ + è¯­è¨€åˆ‡æ¢) -->
        <div class="toolbar">
            <h1 data-i18n="settings_title">è®¾ç½®</h1>
            <!-- è¯­è¨€åˆ‡æ¢ -->
            <button class="btn-secondary" onclick="toggleLanguage()">ğŸŒ <span id="langLabel">EN</span></button>
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
        <div class="user-profile">
            <div class="avatar-placeholder">ğŸ‘¤</div>
            <div class="user-details">
                <div data-i18n="user_label">å½“å‰ç”¨æˆ·</div>
                <div id="userPhoneDisplay">...</div>
                </div>
            <!-- ç”¨æˆ· ID èƒ¶å›Šæ ‡ç­¾ -->
            <div class="user-id-tag">
                <span class="hash-symbol">#</span><span id="userIdDisplay">--</span>
            </div>
        </div>

        <!-- ä¿®æ”¹å¯†ç å¡ç‰‡ -->
        <div class="card" id="pwdCard">
            <div class="card-header">
                <h2 data-i18n="change_pwd_title">ä¿®æ”¹å¯†ç </h2>
            </div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="currentPassword" data-i18n="label_curr_pwd">å½“å‰å¯†ç </label>
                    <input type="password" id="currentPassword" required>
                </div>

                <div class="form-group">
                    <label for="newPassword" data-i18n="label_new_pwd">æ–°å¯†ç </label>
                    <input type="password" id="newPassword" required minlength="6">
                </div>

                <div class="form-group">
                    <label for="confirmNewPassword" data-i18n="label_confirm_pwd">ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="confirmNewPassword" required minlength="6">
                </div>

                <button type="submit" class="btn-primary" id="pwdSubmitBtn">
                    <span data-i18n="btn_confirm_change">ç¡®è®¤ä¿®æ”¹</span>
                </button>
            </form>
        </div>

        <!-- é€€å‡ºç™»å½•åŒºåŸŸ -->
        <div class="card" style="border-color: #fee2e2;">
            <div class="card-header" style="border-bottom:none; padding-bottom:0;">
                <h2 data-i18n="account_actions" style="color:var(--danger)">è´¦æˆ·æ“ä½œ</h2>
            </div>
            <div style="padding-top:15px;">
                <!-- æ˜¾å¼è®¾ç½®å®½åº¦ä¸º 100%ï¼Œåªå½±å“è¿™ä¸ªæŒ‰é’® -->
                <button id="logoutBtn" class="btn-danger" style="width: 100%;" data-i18n="btn_logout">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤å¼¹çª— -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box">
            <div class="modal-title" id="confirmTitle">Confirm</div>
            <div class="modal-msg" id="confirmMsg">Message</div>
            <div class="modal-actions">
                <button class="btn-secondary" id="confirmCancel" data-i18n="cancel">å–æ¶ˆ</button>
                <button class="btn-danger" id="confirmOk" data-i18n="confirm">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨è”ç³»ä¿¡æ¯ (åŠ¨æ€åŠ è½½) -->
    <div class="footer-info">
        <div class="contact-links">
            <a id="linkGithub" target="_blank" class="footer-link" style="display:none">
                <svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                GitHub
            </a>
            <a id="linkEmail" class="footer-link" style="display:none">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg>
                Email
            </a>
            <a id="linkTelegram" target="_blank" class="footer-link" style="display:none">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                Telegram
            </a>
        </div>

        <div class="copyright">
            Â© 2025 Recrong. All rights reserved.
            <span style="margin: 0 5px;">|</span>
            <a href="/tos.html" target="_blank">ToS & Privacy Policy</a>
        </div>
    </div>
    <script>
        // ================= å·¥å…·å‡½æ•° (ä¸ Dashboard ä¿æŒä¸€è‡´) =================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'fadeOut 0.3s forwards'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function showConfirm(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMsg').textContent = message;

                const okBtn = document.getElementById('confirmOk');
                const cancelBtn = document.getElementById('confirmCancel');

                okBtn.textContent = t('confirm'); // ç¡®ä¿æŒ‰é’®æ–‡å­—ä¹Ÿæ˜¯ç¿»è¯‘è¿‡çš„
                cancelBtn.textContent = t('cancel');

                modal.style.display = 'flex'; modal.offsetHeight; modal.classList.add('show');

                const cleanup = () => {
                    modal.classList.remove('show');
                    setTimeout(() => { modal.style.display = 'none'; }, 200);
                    okBtn.replaceWith(okBtn.cloneNode(true));
                    cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                };

                document.getElementById('confirmOk').onclick = () => { cleanup(); resolve(true); };
                document.getElementById('confirmCancel').onclick = () => { cleanup(); resolve(false); };
            });
        }

        // åˆå§‹åŒ–åº•éƒ¨è”ç³»æ–¹å¼
        (function initFooter() {
            // é˜²æ­¢ config.js æœªæ›´æ–°å¯¼è‡´æŠ¥é”™
            if (typeof CONTACT_INFO === 'undefined') return;

            const elGithub = document.getElementById('linkGithub');
            const elEmail = document.getElementById('linkEmail');
            const elTg = document.getElementById('linkTelegram');

            // é…ç½® GitHub
            if (CONTACT_INFO.GITHUB) {
                elGithub.href = CONTACT_INFO.GITHUB;
                elGithub.style.display = 'inline-flex';
            }

            // é…ç½® Email (è‡ªåŠ¨æ·»åŠ  mailto:)
            if (CONTACT_INFO.EMAIL) {
                elEmail.href = 'mailto:' + CONTACT_INFO.EMAIL;
                elEmail.style.display = 'inline-flex';
            }

            // é…ç½® Telegram
            if (CONTACT_INFO.TELEGRAM) {
                elTg.href = CONTACT_INFO.TELEGRAM;
                elTg.style.display = 'inline-flex';
            }
        })();

        // ================= é€»è¾‘å¤„ç† =================
        const phoneNumber = localStorage.getItem('userPhoneNumber');

        // æƒé™æ£€æŸ¥ï¼šä¿®æ”¹å¯†ç 
        const userPerms = parseInt(localStorage.getItem('userPermissions') || '0', 10);
        const PERM_CHANGE_PASSWORD = 2;

        // ç™»å½•æ£€æŸ¥
        if (!userPerms) {
            window.location.href = '/login.html';
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        const phoneDisplay = document.getElementById('userPhoneDisplay');
        const userIdDisplay = document.getElementById('userIdDisplay');

        const userId = localStorage.getItem('userId'); // è¯»å– ID

        if (phoneNumber) {
            phoneDisplay.textContent = phoneNumber;
            phoneDisplay.removeAttribute('data-i18n');
        } else {
            phoneDisplay.setAttribute('data-i18n', 'msg_unknown_user');
            phoneDisplay.textContent = t('msg_unknown_user');
        }

        // æ˜¾ç¤º ID
        if (userId) {
            userIdDisplay.textContent = userId || '-';
        }

        if ((userPerms & PERM_CHANGE_PASSWORD) !== PERM_CHANGE_PASSWORD) {
            // ç›´æ¥éšè—æ•´ä¸ªå¡ç‰‡
            document.getElementById('pwdCard').style.display = 'none';
        }

        // ä¿®æ”¹å¯†ç æäº¤
        const form = document.getElementById('changePasswordForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmNewPassword) {
                showToast(t('msg_pwd_mismatch'), 'error');
                return;
            }

            const submitButton = document.getElementById('pwdSubmitBtn');
            submitButton.disabled = true;
            submitButton.textContent = t('msg_saving');

            try {
                const response = await fetch(`${API_BASE_URL}/api/user/change-password`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(t('msg_success_redirect'), 'success');

                    // æ¸…é™¤æœ¬åœ°æ•°æ®
                    localStorage.removeItem('userPhoneNumber');
                    localStorage.removeItem('userPermissions');
                    localStorage.removeItem('userId');

                    setTimeout(() => { window.location.href = '/login.html'; }, 1500);
                } else {
                    // ä¼˜å…ˆä½¿ç”¨é”™è¯¯ç ç¿»è¯‘
                    const msg = result.code ? t(result.code) : result.error;
                    throw new Error(msg);
                }
            } catch (err) {
                showToast(err.message || t('msg_network_error'), 'error');
                submitButton.disabled = false;
                // æ¢å¤æŒ‰é’®å†…å®¹ï¼Œé‡æ–°ç¿»è¯‘ï¼Œç¡®ä¿åˆ‡æ¢è¯­è¨€åæ­£å¸¸
                submitButton.innerHTML = `<span data-i18n="btn_confirm_change">${t('btn_confirm_change')}</span>`;
            }
        });

        // é€€å‡ºç™»å½• (ä½¿ç”¨ Confirm å¼¹çª—)
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            // å¼¹å‡ºç¡®è®¤æ¡†
            const confirmed = await showConfirm(t('btn_logout'), t('msg_confirm_logout'));
            if (!confirmed) return;

            try {
                await fetch(`${API_BASE_URL}/api/logout`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
            } catch (e) {
                console.error("Logout error", e);
            } finally {
                localStorage.removeItem('userPhoneNumber');
                localStorage.removeItem('userPermissions');
                localStorage.removeItem('userId');
                window.location.href = '/login.html';
            }
        });
    </script>
</body>
</html>